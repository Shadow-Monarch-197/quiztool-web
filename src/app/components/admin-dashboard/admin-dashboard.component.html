<nav class="navbar navbar-expand-lg app-nav shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-semibold" routerLink="/admin-dashboard">
      <i class="bi bi-shield-lock-fill me-2"></i> Admin
    </a>

    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#adminNav"
      aria-controls="adminNav"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="adminNav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
        <li class="nav-item">
          <a class="btn btn-link nav-link px-3" routerLink="/admin-upload">
            <i class="bi bi-cloud-arrow-up me-1"></i>
            Upload MCQ Excel
          </a>
        </li>

        <li class="nav-item">
          <button
            type="button"
            class="btn btn-link nav-link px-3"
            (click)="toggleAttempts()"
          >
            <i
              class="bi"
              [ngClass]="showAttempts ? 'bi-eye-slash' : 'bi-eye'"
            ></i>
            {{ showAttempts ? "Hide Attempts" : "Show Attempts" }}
          </button>
        </li>

        <li class="nav-item">
          <a
            class="btn btn-link nav-link px-3"
            [routerLink]="['/admin-create-question']"
          >
            <i class="bi bi-plus-circle me-1"></i>
            Create Question
          </a>
        </li>

        <li class="nav-item">
          <button
            class="btn btn-danger btn-sm ms-lg-2 rounded-pill px-3"
            (click)="logout()"
          >
            <i class="bi bi-box-arrow-right me-1"></i>
            Logout
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-5 admin-dashboard">
  <h2 class="mb-4 text-center text-primary">Admin Dashboard</h2>

  <div class="d-flex justify-content-center mb-4">
    <button class="btn btn-primary btn-lg" (click)="getAllUsers()">
      <i class="bi bi-people-fill me-2"></i> Get All Users
    </button>
  </div>

  <div *ngIf="alluserlist.length > 0; else noUsers">
    <div class="table-responsive shadow rounded overflow-hidden">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-primary">
          <tr>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Created Date</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of alluserlist">
            <td>{{ user.userid }}</td>
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td>
              <span
                class="badge"
                [ngClass]="{
                  'bg-success': user.role === 'admin',
                  'bg-secondary': user.role !== 'admin'
                }"
              >
                {{ user.role | titlecase }}
              </span>
            </td>
            <td>{{ user.createddate | date : "medium" }}</td>
            <td class="text-end"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <ng-template #noUsers>
    <div class="alert alert-info text-center" role="alert">
      No users to display. Click the button above to load users.
    </div>
  </ng-template>

  <div *ngIf="showAttempts" class="card shadow-sm mt-4 attempts-card">
    <div
      class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center"
    >
      <h5 class="mb-0">Recent Test Attempts</h5>

      <div class="d-flex align-items-center gap-2">
        <label class="form-label mb-0 me-2">Filter by Test:</label>
        <select
          class="form-select form-select-sm"
          [ngModel]="selectedTestId"
          (ngModelChange)="onFilterChange($event)"
        >
          <option [ngValue]="null">All Tests</option>
          <option *ngFor="let t of tests" [ngValue]="t.id">
            {{ t.title }}
          </option>
        </select>

        <button
          class="btn btn-sm btn-outline-secondary"
          (click)="loadAttempts(selectedTestId ?? undefined)"
        >
          Refresh
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>User Email</th>
            <th>Test</th>
            <th class="text-center">Score</th>
            <th class="text-center">%</th>
            <th>Attempted</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngIf="loadingAttempts">
            <td colspan="6" class="text-center py-3">Loading...</td>
          </tr>

          <tr *ngFor="let a of attempts; trackBy: trackByAttempt">
            <td>{{ a.userEmail }}</td>
            <td>
              <span class="fw-semibold">{{ a.testTitle }}</span>
              <small class="text-muted d-block">#{{ a.testId }}</small>
            </td>
            <td class="text-center">{{ a.score }} / {{ a.total }}</td>
            <td class="text-center">{{ a.percent }}%</td>
            <td>{{ a.attemptedAt | date : "short" }}</td>
            <td class="text-end">
              <a
                class="btn btn-sm btn-outline-primary"
                [routerLink]="['/attempts', a.id]"
              >
                Review
              </a>
            </td>
          </tr>

          <tr *ngIf="!loadingAttempts && attempts.length === 0">
            <td colspan="6" class="text-center py-3 text-muted">
              No attempts yet.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
