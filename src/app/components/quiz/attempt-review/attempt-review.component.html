<div class="container py-4" *ngIf="!loading; else busy">
  <div *ngIf="attempt; else notfound">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-1">{{ attempt.testTitle }}</h3>
        <div class="text-muted small">
          Attempt #{{ attempt.attemptId }} • {{ attempt.userEmail }} •
          {{ attempt.attemptedAt | date : "short" }}
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm" style="width: 180px">
          <span class="input-group-text">Score</span>
          <input
            type="number"
            class="form-control"
            [(ngModel)]="newScore"
            [min]="0"
            [max]="attempt.total"
          />
          <span class="input-group-text">/ {{ attempt.total }}</span>
        </div>
        <button
          class="btn btn-primary btn-sm"
          (click)="saveScore()"
          [disabled]="saving || newScore === attempt.score"
        >
          {{ saving ? "Saving…" : "Save" }}
        </button>
      </div>
    </div>

    <div class="vstack gap-3">
      <div class="card" *ngFor="let a of attempt.answers; index as i">
        <div class="card-body">
          <div class="d-flex align-items-start gap-3 mb-2">
           
            <span
              class="bg-primary-subtle text-primary fw-bold d-inline-flex align-items-center justify-content-center"
              style="
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
                border-radius: 50% !important;
                padding: 0 !important;
                line-height: 1;
                flex: 0 0 auto;
              "
            >
              {{ i + 1 }}
            </span>
           

            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">{{ a.questionText }}</h5>

                <span
                  class="badge"
                  [ngClass]="
                    isSubjective(a) ? 'text-bg-warning' : 'text-bg-info'
                  "
                >
                  {{ isSubjective(a) ? "subjective" : "objective" }}
                </span>
              </div>

              <img
                *ngIf="a.imageUrl"
                [src]="buildUrl(a.imageUrl)"
                alt="question image"
                class="img-fluid rounded border mt-2"
                (error)="onImgError($event)"
              />

        
              <div *ngIf="!isSubjective(a)" class="mt-3">
                <div>
                  <span
                    class="badge"
                    [ngClass]="
                      a.isCorrect ? 'text-bg-success' : 'text-bg-danger'
                    "
                  >
                    {{ a.isCorrect ? "Correct" : "Incorrect" }}
                  </span>
                </div>
                <div class="mt-2">
                  <div><b>Selected:</b> {{ a.selectedOptionText || "—" }}</div>
                  <div *ngIf="!a.isCorrect && a.correctOptionText">
                    <b>Correct:</b> {{ a.correctOptionText }}
                  </div>
                </div>
              </div>

      
              <div *ngIf="isSubjective(a)" class="mt-3">
                <label class="form-label mb-1">Student Answer</label>
                <div class="border rounded p-2 mb-2 bg-light-subtle">
                  {{ a.subjectiveText || "—" }}
                </div>
                <label class="form-label mb-1 text-muted">Model Answer</label>
                <div class="border rounded p-2 bg-light-subtle">
                  {{ a.modelAnswer || "—" }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #busy>
  <div class="container py-5 text-center text-muted">Loading…</div>
</ng-template>

<ng-template #notfound>
  <div class="alert alert-warning">Attempt not found.</div>
</ng-template>
