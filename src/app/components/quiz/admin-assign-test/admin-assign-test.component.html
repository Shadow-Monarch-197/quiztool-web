<!-- NEW -->
<div class="container py-4" *ngIf="!loading; else busy">
  <h4 class="mb-3">
    <i class="bi bi-person-check me-2"></i>
    Assign: <span class="text-primary">{{ testTitle }}</span>
  </h4>

  <div class="mb-3 d-flex gap-2">
    <input class="form-control" placeholder="Search name or email…" [(ngModel)]="search" />
    <button class="btn btn-outline-secondary" (click)="selectAllVisible()">Select visible</button>
    <button class="btn btn-outline-secondary" (click)="clearAll()">Clear</button>
  </div>

  <div class="table-responsive shadow-sm rounded">
    <table class="table table-sm align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:48px"></th>
          <th>Name</th>
          <th>Email</th>
          <th style="width:120px">Already</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of filteredUsers()">
          <td>
            <input type="checkbox"
                   class="form-check-input"
                   [checked]="isChecked(u.email)"
                   (change)="toggle(u.email, $any($event.target).checked)" />
          </td>
          <td>{{ u.name }}</td>
          <td class="font-monospace">{{ u.email }}</td>
          <td>
            <span *ngIf="assignees.has(u.email)" class="badge bg-success">Assigned</span>
          </td>
        </tr>
        <tr *ngIf="filteredUsers().length === 0">
          <td colspan="4" class="text-center text-muted py-3">No users match.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-outline-secondary" (click)="cancel()">Cancel</button>
    <button class="btn btn-primary" [disabled]="saving" (click)="save()">
      {{ saving ? 'Saving…' : 'Save Assignments' }}
    </button>
  </div>
</div>

<ng-template #busy>
  <div class="container py-5 text-center text-muted">Loading…</div>
</ng-template>
